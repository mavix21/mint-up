import { SignInButton, StatusAPIResponse } from '@farcaster/auth-kit';
import { getCsrfToken, signIn, signOut } from 'next-auth/react';
import { useCallback, useState } from 'react';

export const SignInWithFarcaster = () => {
  const [error, setError] = useState(false);

  const getNonce = useCallback(async () => {
    const nonce = await getCsrfToken();
    if (!nonce) throw new Error('Unable to generate nonce');
    return nonce;
  }, []);

  const handleSuccess = useCallback((res: StatusAPIResponse) => {
    signIn('credentials', {
      message: res.message,
      signature: res.signature,
      name: res.username,
      pfp: res.pfpUrl,
      redirect: false,
    });
  }, []);

  return (
    <>
      <SignInButton
        onSuccess={handleSuccess}
        onError={() => setError(true)}
        nonce={getNonce}
        onSignOut={() => signOut()}
      />
      {error && <p>Error signing in</p>}
    </>
  );
};
